#AgentCodeStarted
import os
import logging
from flask import request
import requests
import pandas as pd
import json, os, re
from datetime import datetime
from typing import Tuple, List, Dict, Any

LOG_DIR = "/data/logs/ffa94a6ffa1846fc/ffa94a6ffa1846fc_5"
LOG_FILE = os.path.join(LOG_DIR, "ffa94a6ffa1846fc_5.log")
os.makedirs(LOG_DIR, exist_ok=True)
os.makedirs("/data/output/ffa94a6ffa1846fc/", exist_ok=True)

logging.basicConfig(
    filename=LOG_FILE,
    filemode="a",
    format="%(asctime)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

BASE_URL_BE = "https://complianceai-be.accure.ai:9091"

def auth_hdr(token: str) -> dict:
    """Authorization header for API calls"""
    return {"Authorization": f"Bearer {token}"}

def get_checklist(token: str, title_number: int, section_identifier: str) -> dict:
    """Pulls the checklist for a specific CFR Title and Section."""
    url = f"{BASE_URL_BE}/v1/ecfr/titles/{title_number}/sections/{section_identifier}/checklist"
    headers = {**auth_hdr(token), "Accept": "application/json"}

    r = requests.get(url, headers=headers, timeout=60, verify=False)

    if r.status_code == 404:
        return {"_error": "not_found", "status": 404, "url": url, "body": r.text}

    r.raise_for_status()

    try:
        return r.json()
    except ValueError:
        return {
            "_error": "non_json_response",
            "status": r.status_code,
            "url": url,
            "body": r.text,
        }

def vr_list_from_checklist_blocks(blocks: List[str]) -> List[str]:
    """Extract Verifiable Requirements from markdown checklist blocks."""
    out = []
    for block in blocks or []:
        for ln in block.splitlines():
            s = ln.strip()
            if s.startswith("|") and "---" not in s and "Number" not in s:
                cells = [c.strip() for c in s.strip("|").split("|")]
                if len(cells) >= 4:
                    out.append(cells[3])  # 4th column = Verifiable Requirement
                break
    return out

def get_checklists_payload_by_title_section(
    token: str, companies_and_requirements: Dict[str, List[Dict[str, Any]]]
) -> Dict[str, Dict[str, Any]]:
    """
    For each company, pull the checklist payloads for all CFR Titles and Sections.
    Returns nested dict in format:
        {
          "Carsons Consulting": { "10-13.46": payload, ... },
          "Landbaron Farms": { "21-112.40": payload, ... }
        }
    """
    out: Dict[str, Dict[str, Any]] = {}

    for company, requirements in companies_and_requirements.items():
        out[company] = {}
        seen = set()

        for req in requirements:
            title = req.get("CFR_Title")
            section = req.get("CFR_Section")

            if not title or not section:
                continue

            key = f"{title}-{section}"  # maintain "CFR_Title-CFR_Section" format
            if key in seen:
                continue
            seen.add(key)

            payload = get_checklist(token, int(title), section)
            out[company][key] = payload

    return out

def main():
    try:
        logging.info("***************Checklist Agent Triggered***************")
        data = request.get_json(force=True)

        token = data.get("token")
        companies_and_requirements = data.get("companies_and_requirements")

        # --- Pull all checklists for each companyâ€™s CFR Title/Section ---
        result = get_checklists_payload_by_title_section(token, companies_and_requirements)
        logging.info("Finished pulling API responses")

        # --- Extract verifiable requirements and reformat output ---
        checklist = {}

        for company, regs in result.items():
            checklist[company] = []

            for key, payload in regs.items():
                # key format = "Title-Section"
                try:
                    title, section = key.split("-", 1)
                    title = int(title)
                except ValueError:
                    logging.warning("Invalid key format for %s: %s", company, key)
                    continue

                vr_items = vr_list_from_checklist_blocks(payload.get("checklist", []))

                checklist[company].append({
                    "CFR_Title": title,
                    "CFR_Section": section,
                    "Requirements": vr_items
                })

        logging.info("Finished extracting and formatting Verifiable Requirements")

        output = {
            "status": "success",
            "checklist": checklist
        }
        return output

    except Exception as e:
        logging.error("Exception: %s", str(e))
        return {
            "status": "error",
            "message": str(e)
        }

# Agent code ended
