#AgentCodeStarted
import os
import logging
from flask import request
import pandas as pd
import json


LOG_DIR = "/data/logs/ffa94a6ffa1846fc/ffa94a6ffa1846fc_6"
LOG_FILE = os.path.join(LOG_DIR, "ffa94a6ffa1846fc_6.log")
os.makedirs(LOG_DIR, exist_ok=True)
os.makedirs("/data/output/ffa94a6ffa1846fc/", exist_ok=True)

logging.basicConfig(
    filename=LOG_FILE,
    filemode="a",
    format="%(asctime)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

def main():
    try:
        logging.info("***************Format Data triggered***************")
        data = request.get_json(force=True)
        checklist = data.get("checklist")
        companies_and_requirements = data.get("companies_and_requirements")
        formatted_output = {}

        for company, requirements in companies_and_requirements.items():
            formatted_output[company] = []

            for req in requirements:
                title = str(req.get("CFR_Title", ""))
                section = str(req.get("CFR_Section", ""))

                matched_entry = None
                if company in checklist:
                    for item in checklist[company]:
                        # âœ… convert both sides to str before comparison
                        if str(item["CFR_Title"]) == title and str(item["CFR_Section"]) == section:
                            matched_entry = item
                            break

                formatted_output[company].append({
                    "CFR_Title": title,
                    "CFR_Section": section,
                    "Requirements": matched_entry["Requirements"] if matched_entry else []
                })

        logging.info("Agent finished merging and formatting dictionaries")

        output = {
            "status": "success",
            "companies_regulations_and_requirements": formatted_output
        }
        return output

    except Exception as e:
        logging.error("Exception: %s", str(e))
        return {"status": "error", "message": str(e)}
#AgentCodeEnded
