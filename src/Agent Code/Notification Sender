#AgentCodeStarted
import os
import logging
from flask import request
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
from typing import List, Optional, Dict, Union  

LOG_DIR = "/data/logs/ffa94a6ffa1846fc/ffa94a6ffa1846fc_12"
LOG_FILE = os.path.join(LOG_DIR, "ffa94a6ffa1846fc_12.log")
os.makedirs(LOG_DIR, exist_ok=True)
os.makedirs("/data/output/ffa94a6ffa1846fc/", exist_ok=True)

logging.basicConfig(
    filename=LOG_FILE,
    filemode="a",
    format="%(asctime)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

recipient_email = [
    "ajone41@gmu.edu","tpayne24@gmu.edu","sshillin@gmu.edu"
]
gmail_username = $gmail_username
gmail_password = $gmail_password


def send_compliance_email(
    sender_email: str,
    sender_password: str,
    recipient_email: List[str],  
    #compliance_status: str,
    report: str,
    smtp_server: str = "smtp.gmail.com",
    smtp_port: int = 587,
    use_html: bool = False,
    attachments: Optional[List[str]] = None,
) -> bool:
    try:
        msg = MIMEMultipart()
        msg["From"] = sender_email
        msg["To"] = ", ".join(recipient_email)  
        msg["Subject"] = "Compliance Status Report -- Main Workflow"


        body = f"Compliance Status Enclosed\n\nReport:\n{report}\n\n\n This is an Automated Message"
        msg.attach(MIMEText(body, "plain"))

        if attachments:
            for filepath in attachments:
                if os.path.isfile(filepath):
                    with open(filepath, "rb") as file:
                        part = MIMEApplication(
                            file.read(), Name=os.path.basename(filepath)
                        )
                        part["Content-Disposition"] = (
                            f'attachment; filename="{os.path.basename(filepath)}"'
                        )
                        msg.attach(part)
                else:
                    print(f"Attachment not found: {filepath}")

        with smtplib.SMTP(smtp_server, smtp_port, timeout=10) as server:
            server.starttls()
            server.login(sender_email, sender_password)
            server.sendmail(
                sender_email, recipient_email, msg.as_string()
            )  

        print("Email sent successfully.")
        return True

    except smtplib.SMTPException as e:
        print(f"SMTP error occurred: {e}")
        return False
    except Exception as ex:
        print(f"An unexpected error occurred: {ex}")
        return False

    return {
        "status": "success" if all(v == "sent" for v in results.values()) else "partial",
        "results": results,
        "unmatched_body_only": [bodies_norm[n] for n in unmatched_body_only],
        "unmatched_address_only": [addrs_norm[n] for n in unmatched_address_only],
    }

def main():
    try:
        logging.info("***************Email Sender Agent triggered***************")
      
        data = request.get_json(force=True)
        logging.info("request data: %s", data)
        #compliance_status = data.get("compliance_status") cognitive agent only sends one message, not multiple

        report = data.get("compliance_report")
        #recipient_email = [data.get("")]  # Convert to list

        result = send_compliance_email(
            sender_email=gmail_username,
            sender_password=gmail_password,
            recipient_email=recipient_email,
            #compliance_status=compliance_status,
            report=report,
        )

        if result:
            logging.info("Email sent successfully")
            output = {
                "status": "success",
                "message": "Email sent successfully"
            }
        else:
            logging.error("Failed to send email")
            output = {
                "status": "error",
                "message": "Failed to send email"
            }
        return output
    except Exception as e:
        logging.error("Exception: %s", str(e))
        return {
            "status": "error",
            "message": str(e)
        }

#AgentCodeEnded
