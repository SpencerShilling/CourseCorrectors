#AgentCodeStarted
import os
import logging
from flask import request
from pathlib import Path


LOG_DIR = "/data/logs/ffa94a6ffa1846fc/ffa94a6ffa1846fc_2"
LOG_FILE = os.path.join(LOG_DIR, "ffa94a6ffa1846fc_2.log")
os.makedirs(LOG_DIR, exist_ok=True)
os.makedirs("/data/output/ffa94a6ffa1846fc/", exist_ok=True)

logging.basicConfig(
    filename=LOG_FILE,
    filemode="a",
    format="%(asctime)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

def read_company_files(company_dict, base_dir="/data"):
    """
    Reads all files from each unique company directory and returns a combined dictionary.
    Format: {Company_Name: {file_name: file_text}}
    """
    all_company_docs = {}

    for company_name in company_dict.keys():
        # Replace spaces with underscores for directory naming
        dir_name = company_name.replace(" ", "_")
        evidence_path = os.path.join(base_dir, dir_name)
        company_docs = {}

        if not os.path.exists(evidence_path):
            print(f"Directory not found: {evidence_path}")
            continue

        for filename in os.listdir(evidence_path):
            full_path = os.path.join(evidence_path, filename)

            # Skip subdirectories
            if not os.path.isfile(full_path):
                continue

            try:
                with open(full_path, "r", encoding="utf-8", errors="ignore") as f:
                    company_docs[filename] = f.read()
            except Exception as e:
                print(f"Error reading {full_path}: {e}")
                continue

        all_company_docs[company_name] = company_docs

    return all_company_docs


def main():
    try:
        logging.info("***************Read Files from Directory triggered***************")
        data = request.get_json(force=True)
        logging.info("Request Data %s", data)
        companies_and_requirements = data.get("companies_and_requirements")

        evidence_docs = read_company_files(companies_and_requirements)

                
        logging.info("Agent finished reading files")
        output = {
            "status": "success",
            "evidence_docs": evidence_docs
        }
        return output
    except Exception as e:
        logging.error("Exception: %s", str(e))
        return {
            "status": "error",
            "message": str(e)
        }
#AgentCodeEnded
